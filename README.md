# Inverted Glacier Evolution Model — README

Short overview
- This repository implements an inversion workflow for a glacier-evolution forward model + a learned emulator (CNN). The goal is to infer climate parameters (mean temperature T_m_lowest, precipitation P) by minimizing a data-fidelity loss between simulated and observed glacier extent / thickness.

Quick entry points
- Main experiment driver: [main.py](main.py) — sets up emulator, glacier model and runs gradient-based inversions.
- Alternative runner / scripts: [run.py](run.py), [make_movie.sh](make_movie.sh).

How to run (typical)
1. Install dependencies: see [requirements.txt](requirements.txt).
2. Configure run options via [`parse_arguments`](config/read_config.py) in [config/read_config.py](config/read_config.py).
3. Run the main inversion loop:
   - python main.py
   - main.py builds the emulator (CNN loaded from `data/emulator_model.pth`) using the [`CNN`](core/cnn_model.py) class and instantiates the glacier forward model [`GlacierDynamicsCheckpointed`](core/glacier.py).
   - The inversion loop calls [`inversion_extent`](core/inversion.py) (and other inversion helpers) and optimizes parameters (e.g. `T_m_lowest`) with Adam. Outputs are written to files under the `data/` or `data_E/` folders (see "Outputs").

Key modules and responsibilities
- [core/glacier.py](core/glacier.py)
  - [`GlacierDynamicsCheckpointed`](core/glacier.py): checkpointed glacier forward model used for efficient automatic-differentiation through time.
- [core/inversion.py](core/inversion.py)
  - [`inversion_extent`](core/inversion.py): forward pass + IoU / mask-based data-fidelity loss and optional smoothness regularization used by the optimizer.
  - [`inversion_thicknes`](core/inversion.py): alternative inversion objective operating on thickness time-slices.
- [core/smb.py](core/smb.py)
  - Climate / SMB helper functions: [`cosine_temperature_series`](core/smb.py) and [`update_smb`](core/smb.py) implement seasonal/parametric temperature and SMB routines used by the forward model.
- [utils/load.py](utils/load.py)
  - [`load_inversion_results`](utils/load.py): parser for inversion log files like `data/all_inversions/inversion_T8.0_P1.5.txt`.
- [utils/emulator_tools.py](utils/emulator_tools.py)
  - Numerical building blocks for the physical emulator, e.g. [`compute_divflux_limited`](utils/emulator_tools.py) and gradient / slope limiters.
- [core/cnn_model.py](core/cnn_model.py)
  - [`CNN`](core/cnn_model.py): the convolutional emulator (inputs: thk, slopsurfx, slopsurfy; outputs: ubar, vbar). A pretrained checkpoint is at `data/emulator_model.pth`.
- [visualization/plots.py](visualization/plots.py)
  - plotting helpers such as [`visualize_velocities`](visualization/plots.py) used to inspect fields, losses, and inversion progress.

Data & outputs
- Observations and generated outputs:
  - Observation example: `Obs_2D.pt` (generated by the driver).
  - Emulation model: `data/emulator_model.pth`.
- Inversion logs (example filenames and format):
  - `data/all_inversions/inversion_T8.0_P1.5.txt`, `data/P_only/...`, `data_E/...` — these text logs contain per-iteration lines:
    Iter N: loss=..., precip=..., T=...
  - Use [`load_inversion_results`](utils/load.py) to parse these logs into structured lists / DataFrames.
- Other useful directories:
  - `data/`, `data_E/` — multiple experiment outputs.
  - `results/` — postprocessed figures and analysis.
  - `notebooks/` — interactive experiments; `notebooks/checkpointing.ipynb` shows model setup and checkpointing usage.

Important implementation notes
- Main training/inversion loop in [main.py](main.py):
  - Uses Adam to optimize parameters (often `T_m_lowest` and/or precipitation).
  - Early-stopping logic is present (patience + threshold).
  - Writes per-iteration summaries into `data_E/T_only/inversion_{tag}.txt` (see code around the save in main.py).
- Forward model is expensive; the code uses checkpointing (see `torch.utils.checkpoint` usage in notebooks) and a learned emulator to speed up parts of the physics.
- Soft masks are used for data-fidelity (sigmoid-thresholded thickness) in [`inversion_extent`](core/inversion.py).

Useful examples and helpers
- Example inversion logs to inspect convergence and parameter estimates:
  - [data/all_inversions/inversion_T8.0_P1.5.txt](data/all_inversions/inversion_T8.0_P1.5.txt)
  - [data/all_inversions/inversion_T7.0_P2.0.txt](data/all_inversions/inversion_T7.0_P2.0.txt)
  - [data/P_only/inversion_T7.0_P1.0.txt](data/P_only/inversion_T7.0_P1.0.txt)
- Example notebook demonstrating checkpointing and SMB logic:
  - [notebooks/checkpointing.ipynb](notebooks/checkpointing.ipynb)
- Example job script for GPU slurm runs:
  - [notebooks/jobSlurm_gpu.sh](notebooks/jobSlurm_gpu.sh)

Where to look when debugging
- If inversion outputs show no progress or constant values:
  - Inspect loss printing and early-stopping in [main.py](main.py) and the computation of `data_fidelity` in [`inversion_extent`](core/inversion.py).
  - Inspect parsed inversion logs with [`load_inversion_results`](utils/load.py) to ensure lines are parsed correctly.
- If emulator outputs look wrong:
  - Check CNN weights loading in [main.py](main.py) and the [`CNN`](core/cnn_model.py) architecture.
  - Validate numerical fluxes and limiters in [utils/emulator_tools.py](utils/emulator_tools.py).

Contact & next steps
- Use the notebooks for exploratory runs and plotting.
- For new inversions: adjust defaults in [config/read_config.py](config/read_config.py) or pass CLI args to `main.py`.

Files referenced in this README (quick links)
- [main.py](main.py)
- [run.py](run.py)
- [config/read_config.py](config/read_config.py) — [`parse_arguments`](config/read_config.py)
- [core/glacier.py](core/glacier.py) — [`GlacierDynamicsCheckpointed`](core/glacier.py)
- [core/inversion.py](core/inversion.py) — [`inversion_extent`](core/inversion.py), [`inversion_thicknes`](core/inversion.py)
- [core/smb.py](core/smb.py) — [`cosine_temperature_series`](core/smb.py), [`update_smb`](core/smb.py)
- [core/cnn_model.py](core/cnn_model.py) — [`CNN`](core/cnn_model.py)
- [utils/load.py](utils/load.py) — [`load_inversion_results`](utils/load.py)
- [utils/emulator_tools.py](utils/emulator_tools.py) — [`compute_divflux_limited`](utils/emulator_tools.py)
- [visualization/plots.py](visualization/plots.py) — [`visualize_velocities`](visualization/plots.py)
- Example logs: [data/all_inversions/inversion_T8.0_P1.5.txt](data/all_inversions/inversion_T8.0_P1.5.txt) , [data/P_only/inversion_T7.0_P1.0.txt](data/P_only/inversion_T7.0_P1.0.txt)